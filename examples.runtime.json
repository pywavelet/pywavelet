{"version":3,"kind":"Notebook","sha256":"ecfdc5c68c2f6f1f35edfc1762c260910fb9877a2f7c02935d785dbd5ac68494","slug":"examples.runtime","location":"/examples/runtime.ipynb","dependencies":[],"frontmatter":{"title":"Runtime Comparisons","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"pywavelet developers","given":"pywavelet","family":"developers"},"name":"pywavelet developers","id":"contributors-myst-generated-uid-0"}],"github":"https://github.com/pywavelet/pywavelet","settings":{"output_matplotlib_strings":"remove"},"numbering":{"title":{"offset":1}},"source_url":"https://github.com/pywavelet/pywavelet/blob/main/docs/examples/runtime.ipynb","edit_url":"https://github.com/pywavelet/pywavelet/edit/main/docs/examples/runtime.ipynb","thumbnail":"/pywavelet//build/7e2db436150c38a00650f96925aa5581.svg","exports":[{"format":"ipynb","filename":"runtime.ipynb","url":"/pywavelet//build/runtime-790d08795ac4b7aeb773a7d65a67ef09.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"link","url":"https://colab.research.google.com/github/pywavelet/pywavelet/blob/main/docs/runtime.ipynb","children":[{"type":"image","url":"/pywavelet//build/7e2db436150c38a00650f96925aa5581.svg","alt":"Open In Colab","key":"SbfEjDxOSm","urlSource":"https://colab.research.google.com/assets/colab-badge.svg"}],"urlSource":"https://colab.research.google.com/github/pywavelet/pywavelet/blob/main/docs/runtime.ipynb","key":"VW426rUotA"},{"type":"heading","depth":1,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Runtime Comparisons","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"q1zWmYv8DJ"}],"identifier":"runtime-comparisons","label":"Runtime Comparisons","html_id":"runtime-comparisons","implicit":true,"key":"lDCTl1h0s5"}],"key":"XJZXUY4qBJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import time\n\n! pip install pywavelet -q","key":"NmQrxaZyVN"},{"type":"outputs","id":"RRrrXaqWiR41m6hHwnTPK","children":[],"key":"l5pM5vjFQj"}],"key":"A12tiPAQdY"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"editable":true,"jupyter":{"outputs_hidden":true},"slideshow":{"slide_type":""},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport jax.numpy as jnp\nimport pandas as pd\nimport jax\nimport json\nimport os\n\nfrom pywavelet.backend import cuda_available\nfrom tqdm.auto import tqdm\nfrom pywavelet.types import FrequencySeries\nfrom pywavelet.transforms.phi_computer import phitilde_vec_norm\nfrom timeit import repeat as timing_repeat\nimport matplotlib.pyplot as plt\nfrom typing import Tuple\nimport glob\n\njax.config.update(\"jax_enable_x64\", False)\nJAX_DEVICE = jax.default_backend()\nJAX_PRECISION = \"x64\" if jax.config.jax_enable_x64 else \"x32\"\n\nif cuda_available:\n    import cupy as cp\n\nmin_pow2 = 2\nmax_pow2 = 14\nNF = [2**i for i in range(min_pow2, max_pow2)]\nNREP = 5\n\n\ndef generate_freq_domain_signal(\n    ND, f0=20.0, dt=0.0125, A=2\n) -> FrequencySeries:\n    \"\"\"\n    Generates a frequency domain signal.\n\n    Parameters:\n    ND (int): Number of data points.\n    f0 (float): Frequency of the signal. Default is 20.0.\n    dt (float): Time step. Default is 0.0125.\n    A (float): Amplitude of the signal. Default is 2.\n\n    Returns:\n    FrequencySeries: The generated frequency domain signal.\n    \"\"\"\n    ts = np.arange(0, ND) * dt\n    y = A * np.sin(2 * np.pi * f0 * ts)\n    yf = FrequencySeries(y, ts)\n    return yf\n\n\ndef generate_func_args(ND: int, label=\"numpy\") -> Tuple:\n    Nf = Nt = int(np.sqrt(ND))\n    yf = generate_freq_domain_signal(ND).data\n    phif = phitilde_vec_norm(Nf, Nt, d=4.0)\n    if \"jax\" in label:\n        yf = jnp.array(yf)\n        phif = jnp.array(phif)\n    if \"cupy\" in label and cuda_available:\n        yf = cp.array(yf)\n        phif = cp.array(phif)\n    return yf, Nf, Nt, phif\n\n\ndef collect_runtime(func, func_args) -> Tuple[float, float]:\n    warm_time = 0\n    for i in range(5):\n        t0 = time.process_time()\n        func(*func_args)  # Warm up run\n        warm_time = time.process_time() - t0\n\n    if warm_time < 0.001:\n        number = 1000\n    elif warm_time < 0.1:\n        number = 10\n    else:\n        number = 1\n    # see https://stackoverflow.com/questions/48258008/n-and-r-arguments-to-ipythons-timeit-magic/59543135#59543135\n\n    times = timing_repeat(lambda: func(*func_args), number=number, repeat=NREP)\n    return np.median(times), np.std(times)\n\n\ndef collect_runtimes(func, label, NF_values) -> np.ndarray:\n    results = np.zeros((len(NF_values), 3))\n    bar = tqdm(NF_values, desc=\"Running\")\n    for i, Nf in enumerate(bar):\n        ND = Nf * Nf\n        bar.set_postfix(ND=f\"2**{int(np.log2(ND))}\")\n        func_args = generate_func_args(ND, label)\n        try:\n            _times = collect_runtime(func, func_args)\n        except Exception as e:\n            print(f\"Error processing ND={ND}: {e}\")\n            _times = (np.nan, np.nan)\n        results[i] = np.array([ND, *_times])\n\n    runtimes = pd.DataFrame(results, columns=[\"ND\", \"median\", \"std\"])\n    runtimes.to_csv(f\"runtime_{label}.csv\", index=False)\n\n    return runtimes\n\n\ndef save_jax_runtimes():\n    from pywavelet.transforms.jax.forward.from_freq import (\n        transform_wavelet_freq_helper as jax_transform,\n    )\n\n    jax_label = f\"jax_{JAX_DEVICE}_{JAX_PRECISION}\"\n    collect_runtimes(jax_transform, jax_label, NF)\n\n\ndef save_cupy_runtimes():\n    from pywavelet.transforms.cupy.forward.from_freq import (\n        transform_wavelet_freq_helper as cp_transform,\n    )\n\n    collect_runtimes(cp_transform, \"cupy\", NF)\n\n\ndef save_numpy_runtimes():\n    from pywavelet.transforms.numpy.forward.from_freq import (\n        transform_wavelet_freq_helper as np_transform,\n    )\n\n    collect_runtimes(np_transform, \"numpy\", NF)\n\n\ndef cache_all_runtimes(cache_fn: str = \"runtimes.json\"):\n    data = {}\n    for f in glob.glob(\"runtime_*.csv\"):\n        df = pd.read_csv(f)\n        label = f.split(\"runtime_\")[1].split(\".\")[0]\n        data[label] = df.to_dict(orient=\"records\")\n\n    # load any existing data\n    if os.path.exists(cache_fn):\n        with open(cache_fn, \"r\") as f:\n            existing_data = json.load(f)\n            data.update(existing_data)\n\n    # save to json\n    with open(cache_fn, \"w\") as f:\n        json.dump(data, f, indent=4)\n\n\nsave_numpy_runtimes()\nsave_jax_runtimes()\ncache_all_runtimes()","visibility":"hide","key":"N98npBejAK"},{"type":"outputs","id":"L6XrtxUkh7tzpcfoL6KUp","children":[],"visibility":"show","key":"eCXhOxRdDn"}],"visibility":"show","key":"W4OTW6crV1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import matplotlib.pyplot as plt\nimport pandas as pd\nimport json\nimport numpy as np\nfrom typing import Tuple\n\n\nimport matplotlib.pyplot as plt\n\n# Set the desired RC parameters\nrc_params = {\n    \"xtick.direction\": \"in\",  # Mirrored ticks (in and out)\n    \"ytick.direction\": \"in\",\n    \"xtick.top\": True,  # Show ticks on the top spine\n    \"ytick.right\": True,  # Show ticks on the right spine\n    \"xtick.major.size\": 6,  # Length of major ticks\n    \"ytick.major.size\": 6,\n    \"xtick.minor.size\": 4,  # Length of minor ticks\n    \"ytick.minor.size\": 4,\n    \"xtick.major.pad\": 4,  # Padding between tick and label\n    \"ytick.major.pad\": 4,\n    \"xtick.minor.pad\": 4,\n    \"ytick.minor.pad\": 4,\n    \"font.size\": 14,  # Overall font size\n    \"axes.labelsize\": 16,  # Font size of axis labels\n    \"axes.titlesize\": 18,  # Font size of plot title\n    \"xtick.labelsize\": 12,  # Font size of x-axis tick labels\n    \"ytick.labelsize\": 12,  # Font size of y-axis tick labels\n    \"xtick.major.width\": 2,  # Thickness of major ticks\n    \"ytick.major.width\": 2,  # Thickness of major ticks\n    \"xtick.minor.width\": 1,  # Thickness of minor ticks\n    \"ytick.minor.width\": 1,  # Thickness of minor ticks\n    \"lines.linewidth\": 3,  # Default linewidth for lines in plots\n    \"patch.linewidth\": 4,  # Default linewidth for patches (e.g., rectangles, circles)\n    \"axes.linewidth\": 2,  # Default linewidth for the axes spines\n}\n\n# Apply the RC parameters globally\nplt.rcParams.update(rc_params)\n\n\nJAX_LOGO = \"https://github.com/jax-ml/jax/blob/main/images/jax_logo.png\"\nNUMPY_LOGO = \"https://github.com/numpy/numpy/blob/main/branding/logo/primary/numpylogo.png\"\nCUPY_LOGO = (\n    \"https://github.com/cupy/cupy/blob/main/docs/image/cupy_logo_1000px.png\"\n)\n\n\ndef plot_all_runtimes(cache_fn: str = \"runtimes.json\"):\n    fig, ax = plt.subplots(figsize=(4, 3.5))\n\n    with open(cache_fn, \"r\") as f:\n        data = json.load(f)\n        for label, runtimes in data.items():\n            runtimes = pd.DataFrame(runtimes)\n            _, _, line = plot(runtimes, ax=ax, label=label)\n    ax.legend(frameon=False)\n    return fig, ax\n\n\ndef plot(\n    runtimes: pd.DataFrame, ax=None, **kwgs\n) -> Tuple[plt.Figure, plt.Axes]:\n    if ax is None:\n        fig, ax = plt.subplots(figsize=(4, 3.5))\n    fig = ax.figure\n\n    runtimes = runtimes.dropna()\n    runtimes = runtimes.sort_values(by=\"ND\")\n\n    nds = runtimes[\"ND\"].values\n    times, stds = runtimes[\"median\"], runtimes[\"std\"]\n    line = ax.plot(nds, times, **kwgs)\n    kwgs[\"label\"] = None\n    ax.fill_between(\n        nds,\n        np.array(times) - np.array(stds),\n        np.array(times) + np.array(stds),\n        alpha=0.3,\n        **kwgs,\n    )\n\n    ax.set_yscale(\"log\")\n    ax.set_xscale(\"log\")\n    ax.set_xlabel(\"Number of Data Points\")\n    ax.set_ylabel(\"Runtime (s)\")\n    return fig, ax, line\n\n\nfig, ax = plot_all_runtimes()\nfig.savefig(\"runtimes.png\", bbox_inches=\"tight\")","key":"sc3aXWaagV"},{"type":"outputs","id":"_E6UIxCxCHvmwaxas-ooB","children":[],"key":"iGpcFMwqnd"}],"key":"q6cENA2RPL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Runtime comparison figure is generated during benchmarking and is not checked into the repository.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dzTQcyMHnI"}],"key":"xkog4iyjRS"}],"key":"Y4CsRBVyab"}],"key":"ikeRHX0Ait"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Example","url":"/examples/basic","group":" "},"next":{"title":"Accuracy checks","url":"/examples/accuracy","group":" "}}},"domain":"http://localhost:3000"}